!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define("inkjs",["exports"],e):e(t.inkjs=t.inkjs||{})}(this,function(t){"use strict";var e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),r=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t},o=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},s=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},u=function(){function t(){n(this,t),this._isRelative,this._components=[],"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof l&&arguments[1]instanceof t?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1])):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return a(t,[{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,a=0;a<e.components.length&&e.components[a].isParent;++a)i++;for(a=0;a<this.components.length-i;++a)n.components.push(this.components[a]);for(a=i;a<e.components.length;++a)n.components.push(e.components[a]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t.components.length!=this.components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t.components.length;e<n;e++)if(!t.components[e].Equals(this.components[e]))return!1;return!0}},{key:"isRelative",get:function(){return this._isRelative}},{key:"components",get:function(){return this._components}},{key:"head",get:function(){return this.components.length>0?this.components[0]:null}},{key:"tail",get:function(){return this.components.length>=2?new t(this.components.slice(1,this.components.length)):t.self}},{key:"length",get:function(){return this.components.length}},{key:"lastComponent",get:function(){return this.components.length>0?this.components[this.components.length-1]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this.components.length;t<e;t++)if(!this.components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){var t=this.components.join(".");return this.isRelative?"."+t:t},set:function(t){var e=this;this.components.length=0;var n=t;null!=n&&""!=n&&("."==n[0]&&(this._isRelative=!0,n=n.substring(1)),n.split(".").forEach(function(t){/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?e.components.push(new l(parseInt(t))):e.components.push(new l(t))}))}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}(),l=function(){function t(e){n(this,t),"string"==typeof e?(this._index=-1,this._name=e):(this._index=parseInt(e),this._name=null)}return a(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==u.parentId}}],[{key:"ToParent",value:function(){return new t(u.parentId)}}]),t}();u.parentId="^",u.Component=l;var h=function(){function t(){n(this,t),this.parent=null,this._path=null}return a(t,[{key:"ResolvePath",value:function(t){if(t.isRelative){var e=this;return e instanceof T==!1&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),"Container"!==(e=this.parent).constructor.name&&console.warn("Expected parent to be a container"),t=t.tail),e.ContentAtPath(t)}return this.rootContentContainer.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.components.length,e.components.length),i=-1,a=0;a<n;++a){var r=e.components[a],o=t.components[a];if(!r.Equals(o))break;i=a}if(-1==i)return t;for(var s=e.components.length-1-i,l=[],h=0;h<s;++h)l.push(u.Component.ToParent());for(var c=i+1;c<t.components.length;++c)l.push(t.components[c]);return new u(l,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString);return n.Length<e.Length?n:e}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new u;else{for(var t=[],e=this,n=e.parent;n instanceof T;){var i=e;i.name&&i.hasValidName?t.unshift(new u.Component(i.name)):t.unshift(new u.Component(n.content.indexOf(e))),e=n,n=n.parent}this._path=new u(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return t}}]),t}(),c=function(){function t(e){n(this,t),e=void 0!==e?e.toString():"",this._string=e}return a(t,[{key:"Append",value:function(t){this._string+=t}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this._string+="\n"}},{key:"AppendFormat",value:function(t){var e=Array.prototype.slice.call(arguments,1);return t.replace(/{(\d+)}/g,function(t,n){return void 0!==e[n]?e[n]:t})}},{key:"toString",value:function(){return this._string}},{key:"Length",get:function(){return this._string.length}}]),t}(),f=function(){function t(e,i){if(n(this,t),void 0!==i)this.originName=e,this.itemName=i;else{var a=e.toString().split(".");this.originName=a[0],this.itemName=a[1]}}return a(t,[{key:"isNull",value:function(){return null==this.originName&&null==this.itemName}},{key:"toString",value:function(){return this.fullname}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"toString",value:function(){var t="0",e=this.itemName?this.itemName.toString():"null";return null!=this.originName&&(t=this.originName.toString()),t+e}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"Null",value:function(){return new t(null,null)}}]),t}(),v=function(){function t(e,i){var a=this;if(n(this,t),this._keys={},this._values={},this.origins=null,this._originNames=null,e)if(e instanceof t){var r=e;r.forEach(function(t){a.Add(t.Key,t.Value)}),this._originNames=r._originNames}else if("string"==typeof e){this.SetInitialOriginName(e);var o=null;if(!(o=i.listDefinitions.TryGetDefinition(e,o)))throw new Error("InkList origin could not be found in story when constructing new list: "+singleOriginListName);this.origins=[o]}else if(e.hasOwnProperty("Key")&&e.hasOwnProperty("Value")){var s=e;this.Add(s.Key,s.Value)}}return a(t,[{key:"forEach",value:function(t){for(var e in this._values)t({Key:this._keys[e],Value:this._values[e]})}},{key:"AddItem",value:function(t){var e=this;if(t instanceof f){if(null==(a=t).originName)return void this.AddItem(a.itemName);throw this.origins.forEach(function(t){if(t.name==a.originName){var n;if(void 0!==(n=t.TryGetValueForItem(a,n)))return void e.Add(a,n);throw"Could not add the item "+a+" to this list because it doesn't exist in the original list definition in ink."}}),"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found."}var n=t,i=null;if(this.origins.forEach(function(t){if(t.ContainsItemWithName(n)){if(null!=i)throw"Could not add the item "+n+" to this list because it could come from either "+t.name+" or "+i.name;i=t}}),null==i)throw"Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.";var a=new f(i.name,n),r=i.ValueForItem(a);this.Add(a,r)}},{key:"ContainsItemNamed",value:function(t){var e=!1;return this.forEach(function(n){n.Key.itemName==t&&(e=!0)}),e}},{key:"ContainsKey",value:function(t){return t in this._values}},{key:"Add",value:function(t,e){this._keys[t]=t,this._values[t]=e}},{key:"Remove",value:function(t){delete this._values[t],delete this._keys[t]}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(e){var n=new t(this);return e.forEach(function(t){n.Add(t.Key,t.Value)}),n}},{key:"Intersect",value:function(e){var n=new t;return this.forEach(function(t){e.ContainsKey(t.Key)&&n.Add(t.Key,t.Value)}),n}},{key:"Without",value:function(e){var n=new t(this);return e.forEach(function(t){n.Remove(t.Key)}),n}},{key:"Contains",value:function(t){var e=this,n=!0;return t.forEach(function(t){e.ContainsKey(t.Key)||(n=!1)}),n}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new t(this.maxItem):new t}},{key:"MinAsList",value:function(){return this.Count>0?new t(this.minItem):new t}},{key:"Equals",value:function(e){var n=e;if(n instanceof t==!1)return!1;if(n.Count!=this.Count)return!1;var i=!0;return this.forEach(function(t){n.ContainsKey(t.Key)||(i=!1)}),i}},{key:"toString",value:function(){var t=[];this.forEach(function(e){t.push(e)}),t=t.sort(function(t,e){return t.Value===e.Value?0:t.Value>e.Value?1:-1});for(var e=new c,n=0;n<t.length;n++){n>0&&e.Append(", ");var i=t[n].Key;e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return Object.keys(this._values).length}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every(function(n){return n.name!=t||(e=n,!1)}),e}},{key:"originNames",get:function(){var t=this;return this.Count>0&&(null==this._originNames&&this.Count>0?this._originNames=[]:this._originNames.length=0,this.forEach(function(e){t._originNames.push(e.Key.originName)})),this._originNames}},{key:"maxItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value>t.Value)&&(t=e)}),t}},{key:"minItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value<t.Value)&&(t=e)}),t}},{key:"inverse",get:function(){var e=this,n=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.ContainsKey(t.Key)||n.Add(t.Key,t.Value)})}),n}},{key:"all",get:function(){var e=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.Add(t.Key,t.Value)})}),e}}]),t}(),d={Int:0,Float:1,List:2,String:3,DivertTarget:4,VariablePointer:5},p=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._valueType,i._isTruthy,i._valueObject,i}return o(e,h),a(e,[{key:"Cast",value:function(t){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(t){return e.Create(t)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(t){"boolean"==typeof t&&(t=!!t?1:0);return Number.isInteger(Number(t))?new y(t):isNaN(t)?"string"==typeof t?new k(t):t instanceof u?new C(t):t instanceof v?new S(t):null:new g(t)}}]),e}(),m=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.value=t,i}return o(e,p),a(e,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}},{key:"valueObject",get:function(){return this.value}}]),e}(),y=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return i._valueType=d.Int,i}return o(e,m),a(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==d.Float)return new g(parseFloat(this.value));if(t==d.String)return new k(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return d.Int}}]),e}(),g=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return i._valueType=d.Float,i}return o(e,m),a(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==d.Int)return new y(parseInt(this.value));if(t==d.String)return new k(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return d.Float}}]),e}(),k=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||""));return i._valueType=d.String,i._isNewline="\n"==i.value,i._isInlineWhitespace=!0,i.value.split().every(function(t){return" "==t||"\t"==t||(i._isInlineWhitespace=!1,!1)}),i}return o(e,m),a(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;var e,n;if(t==d.Int)return(e=parseInt(value))?new y(e):null;if(t==d.Float)return(n=n(value))?new g(n):null;throw"Unexpected type cast of Value to new ValueType"}},{key:"valueType",get:function(){return d.String}},{key:"isTruthy",get:function(){return this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(),C=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._valueType=d.DivertTarget,i}return o(e,m),a(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),e}(),b=function(t){function e(t,i){n(this,e);var a=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return a._valueType=d.VariablePointer,a.contextIndex=void 0!==i?i:-1,a}return o(e,m),a(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),e}(),S=function(t){function e(t,i){n(this,e);var a=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,null));return a._valueType=d.List,a.value=t instanceof v?new v(t):void 0!==t&&void 0!==i?new v({Key:t,Value:i}):new v,a}return o(e,m),a(e,[{key:"Cast",value:function(t){var e;if(t==d.Int)return(e=this.value.maxItem).Key.isNull?new y(0):new y(e.Value);if(t==d.Float)return(e=this.value.maxItem).Key.isNull?new g(0):new g(parseFloat(e.Value));if(t==d.String)return(e=value.maxItem).Key.isNull?new k(""):new k(e.Key.toString());if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"valueType",get:function(){return d.List}},{key:"isTruthy",get:function(){var t=!1;return this.value.forEach(function(e){0!=e.Value&&(t=!0)}),t}}]),a(e,null,[{key:"RetainListOriginsForAssignment",value:function(t,n){var i=t,a=n;i instanceof e&&a instanceof e&&0==a.value.Count&&a.value.SetInitialOriginNames(i.value.originNames)}}]),e}(),_=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.message=t,i.name="StoryException",i}return o(e,t),e}(Error),T=function(t){function e(){n(this,e);var t=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return t.name="",t._content=[],t.namedContent={},t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t.CountFlags={Visits:1,Turns:2,CountStartOnly:4},t._pathToFirstLeafContent=null,t}return o(e,h),a(e,[{key:"AddContent",value:function(t){var e=this;if(t instanceof Array)t.forEach(function(t){e.AddContent(t)});else{if(this._content.push(t),t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t.hasValidName&&t.name&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){t instanceof h==!1&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),t.parent=this,this.namedContent[t.name]=t}},{key:"ContentAtPath",value:function(t,n){n=void 0!==n?n:t.components.length;for(var i=this,a=this,r=0;r<n;++r){var o=t.components[r];if(!(i instanceof e))throw"Path continued, but previous object wasn't a container: "+a;i=a=i.ContentWithPathComponent(o)}return a}},{key:"InsertContent",value:function(t,e){if(this.content[i]=t,t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e=this;this.content=this.content.concat(t.content),t.content.forEach(function(t){t.parent=e,e.TryAddNamedContent(t)})}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;var e;if(e=this.namedContent[t.name])return e;throw new _("Content '"+t.name+"' not found at path: '"+this.path+"'")}},{key:"BuildStringOfHierarchy",value:function(t,n,i){if(0==arguments.length){t=new c;return this.BuildStringOfHierarchy(t,0,null),t.toString()}function a(){for(var e=0;e<4*n;++e)t.Append(" ")}a(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==i&&t.Append("  <---"),t.AppendLine(),n++;for(var r=0;r<this.content.length;++r){var o=this.content[r];if(o instanceof e)o.BuildStringOfHierarchy(t,n,i);else a(),o instanceof k?(t.Append('"'),t.Append(o.toString().replace("\n","\\n")),t.Append('"')):t.Append(o.toString());r!=this.content.length-1&&t.Append(","),o instanceof e||o!=i||t.Append("  <---"),t.AppendLine()}var s={};for(var u in this.namedContent)this.content.indexOf(this.namedContent[u])>=0||(s[u]=this.namedContent[u]);if(Object.keys(s).length>0)for(var u in a(),t.AppendLine("-- named: --"),s){s[u]instanceof e||console.warn("Can only print out named Containers"),s[u].BuildStringOfHierarchy(t,n,i),t.Append("\n")}n--,a(),t.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t={};for(var e in this.namedContent)t[e]=this.namedContent[e];return this.content.forEach(function(e){var n=e;n.name&&n.hasValidName&&delete t[n.name]}),0==Object.keys(t).length&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e)for(var n in e)delete this.namedContent[n];if(null!=t)for(var n in t){var i=t[n];i.name&&void 0!==i.hasValidName&&this.AddToNamedContentOnly(i)}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=this.CountFlags.Turns),this.countingAtStartOnly&&(t|=this.CountFlags.CountStartOnly),t==this.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&this.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&this.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&this.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=new Path,n=this;n instanceof e;)n.content.length>0&&(t.components.push(new Path.Component(0)),n=n.content[0]);return t}}]),e}(),O=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.glueType=t,i}return o(e,h),a(e,[{key:"toString",value:function(){switch(this.glueType){case E.Bidirectional:return"BidirGlue";case E.Left:return"LeftGlue";case E.Right:return"RightGlue"}return"UnexpectedGlueType"}},{key:"isLeft",get:function(){return this.glueType==E.Left}},{key:"isBi",get:function(){return this.glueType==E.Bidirectional}},{key:"isRight",get:function(){return this.glueType==E.Right}}]),e}(),E={Bidirectional:0,Left:1,Right:2},w=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._commandType=void 0!==t?t:x.NotSet,i}return o(e,h),a(e,[{key:"copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new e(x.EvalStart)}},{key:"EvalOutput",value:function(){return new e(x.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(x.EvalEnd)}},{key:"Duplicate",value:function(){return new e(x.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(x.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(x.PopFunction)}},{key:"PopTunnel",value:function(){return new e(x.PopTunnel)}},{key:"BeginString",value:function(){return new e(x.BeginString)}},{key:"EndString",value:function(){return new e(x.EndString)}},{key:"NoOp",value:function(){return new e(x.NoOp)}},{key:"ChoiceCount",value:function(){return new e(x.ChoiceCount)}},{key:"TurnsSince",value:function(){return new e(x.TurnsSince)}},{key:"ReadCount",value:function(){return new e(x.ReadCount)}},{key:"Random",value:function(){return new e(x.Random)}},{key:"SeedRandom",value:function(){return new e(x.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(x.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(x.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(x.StartThread)}},{key:"Done",value:function(){return new e(x.Done)}},{key:"End",value:function(){return new e(x.End)}},{key:"ListFromInt",value:function(){return new e(x.ListFromInt)}},{key:"ListRange",value:function(){return new e(x.ListRange)}}]),e}(),x={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20,ReadCount:21};x.TOTAL_VALUES=Object.keys(x).length-1,w.CommandType=x;var I={Tunnel:0,Function:1},P=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._targetPath,i._targetContent,i.variableDivertName,i.pushesToStack,i.stackPushType,i.isExternal,i.isConditional,i.externalArgs,i.pushesToStack=!1,t&&(i.pushesToStack=!0,i.stackPushType=t),i}return o(e,h),a(e,[{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new c,e=this.targetPath.toString();return t.Append("Divert"),this.pushesToStack&&(this.stackPushType==I.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetContent;t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetContent=null}},{key:"targetContent",get:function(){return null==this._targetContent&&(this._targetContent=this.ResolvePath(this._targetPath)),this._targetContent}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new u(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),e}(),A=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._pathOnChoice,i.hasCondition,i.hasStartContent,i.hasChoiceOnlyContent,i.onceOnly,i.isInvisibleDefault,i.onceOnly=!!t,i}return o(e,h),a(e,[{key:"toString",value:function(){var t=this.pathOnChoice.toString();return"Choice: -> "+t}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return this.ResolvePath(this._pathOnChoice)}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new u(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}}]),e}(),N=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.name=t,i.pathForCount,i}return o(e,h),a(e,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount)}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null==t?null:new u(t)}}]),e}(),V=function(t){function e(t,i){n(this,e);var a=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return a._variableName=t||null,a._isNewDeclaration=!!i,a.isGlobal,a}return o(e,h),a(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),e}(),F=function(t){function e(){return n(this,e),s(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return o(e,h),e}(),j=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i.name=t,i._numberOfParameters,i._prototype,i._isPrototype,i._operationFuncs=null,e.GenerateNativeFunctionsIfNecessary(),i}return o(e,h),a(e,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw"Unexpected number of parameters";var e=!1;if(t.forEach(function(t){if(t instanceof F)throw new _("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?");t instanceof S&&(e=!0)}),2==t.length&&e)return this.CallBinaryListOperation(t);var n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==d.Int?this.CallType(n):i==d.Float?this.CallType(n):i==d.String?this.CallType(n):i==d.DivertTarget?this.CallType(n):i==d.List?this.CallType(n):null}},{key:"CallType",value:function(t){var e=t[0],n=e.valueType,i=e,a=t.length;if(2==a||1==a){var r=this._operationFuncs[n];if(!r)throw new _("Cannot perform operation '"+this.name+"' on "+n);if(2==a){var o=t[1],s=r(i.value,o.value);return m.Create(s)}s=r(i.value);return m.Create(s)}throw"Unexpected number of parameters to NativeFunctionCall: "+t.length}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof S&&t[1]instanceof y)return this.CallListIncrementOperation(t);var e=t[0],n=t[1];if(!("&&"!=this.name&&"||"!=this.name||e.valueType==d.List&&n.valueType==d.List)){var i=(0,this._operationFuncs[d.Int])(e.isTruthy?1:0,n.isTruthy?1:0);return new y(i)}if(e.valueType==d.List&&n.valueType==d.List)return this.CallType([e,n]);throw new _("Can not call use '"+this.name+"' operation on "+e.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(t){var e=this,n=t[0],i=t[1],a=new v;return n.value.forEach(function(t){var r=t.Key,o=t.Value,s=(0,e._operationFuncs[d.Int])(o,i.value),u=null;if(n.value.origins.forEach(function(t){if(t.name==r.originName)return u=t,!1}),null!=u){var l=u.TryGetItemWithValue(s);l.exists&&a.Add(l.item,s)}}),new S(a)}},{key:"CoerceValuesToSingleType",value:function(t){var e=d.Int,n=null;t.forEach(function(t){var i=t;i.valueType>e&&(e=i.valueType),i.valueType==d.List&&(n=i)});var i=[];return e==d.List?t.forEach(function(t){if(t.valueType==d.List)i.push(t);else{if(t.valueType!=d.Int)throw new _("Cannot mix Lists and "+t.valueType+" values in this operation");var e=parseInt(t.valueObject),a=n.value.originOfMaxItem,r=a.TryGetItemWithValue(e);if(!r.exists)throw new _("Could not find List item with the value "+e+" in "+a.name);var o=new S(r.item,e);i.push(o)}}):t.forEach(function(t){var n=t.Cast(e);i.push(n)}),i}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[t]=e}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(t){this._name=t,this._isPrototype||(this._prototype=e._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"internalConstructor",value:function(t,n){var i=new e(t);return i._isPrototype=!0,i.numberOfParameters=n,i}},{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[t]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){if(null==this._nativeFunctions){this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return parseInt(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return t.Count>0&&e.Count>0?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return t.Count>0||e.Count>0?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value});this.AddOpToNativeFunc(this.Equal,2,d.DivertTarget,function(t,e){return t.Equals(e)?1:0})}}},{key:"AddOpToNativeFunc",value:function(t,n,i,a){var r=this._nativeFunctions[t];r||(r=e.internalConstructor(t,n),this._nativeFunctions[t]=r),r.AddOpFuncForType(i,a)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,d.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,d.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,d.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,d.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,d.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,d.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,d.List,e)}}]),e}();j.Add="+",j.Subtract="-",j.Divide="/",j.Multiply="*",j.Mod="%",j.Negate="_",j.Equal="==",j.Greater=">",j.Less="<",j.GreaterThanOrEquals=">=",j.LessThanOrEquals="<=",j.NotEquals="!=",j.Not="!",j.And="&&",j.Or="||",j.Min="MIN",j.Max="MAX",j.Has="?",j.Hasnt="!?",j.Intersect="^",j.ListMin="LIST_MIN",j.ListMax="LIST_MAX",j.All="LIST_ALL",j.Count="LIST_COUNT",j.ValueOfList="LIST_VALUE",j.Invert="LIST_INVERT",j._nativeFunctions=null;var L=function(t){function e(t){n(this,e);var i=s(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._text=t.toString()||"",i}return o(e,h),a(e,[{key:"toString",value:function(){return"# "+this._text}},{key:"text",get:function(){return this._text}}]),e}(),R=function(){function t(e){n(this,t),this.text,this.index,this.choicePoint,this.threadAtGeneration,this._originalThreadIndex,this._originalChoicePath,e&&(this.choicePoint=e)}return a(t,[{key:"pathStringOnChoice",get:function(){return this.choicePoint.pathStringOnChoice}},{key:"sourcePath",get:function(){return this.choicePoint.path.componentsString}}]),t}(),D=function(){function t(e,i){n(this,t),this._name=e||"",this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=i||{}}return a(t,[{key:"forEachItems",value:function(t){for(var e in this._rawListItemsKeys)t({Key:this._rawListItemsKeys[e],Value:this._items[e]})}},{key:"ValueForItem",value:function(t){var e=this._itemNameToValues[t.itemName];return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return t.originName==this.name&&t.itemName in this._itemNameToValues}},{key:"ContainsItemWithName",value:function(t){return void 0!==this._itemNameToValues[t]}},{key:"TryGetItemWithValue",value:function(t,e){for(var n in this._itemNameToValues)if(this._itemNameToValues[n]==t)return{item:new f(this.name,n),exists:!0};return{item:f.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){return intVal=this._itemNameToValues[t.itemName],intVal}},{key:"ListRange",value:function(t,e){var n=new v;for(var i in this._itemNameToValues)if(this._itemNameToValues[i]>=t&&this._itemNameToValues[i]<=e){var a=new f(this.name,i);n.Add(a,this._itemNameToValues[i])}return new S(n)}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items)for(var t in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var e=new f(this.name,t);this._rawListItemsKeys[e]=e,this._items[e]=this._itemNameToValues[t]}return this._items.forEach=this.forEachItems.bind(this),this._items}}]),t}(),B=function(){function t(e){var i=this;n(this,t),this._lists={},e.forEach(function(t){i._lists[t.name]=t})}return a(t,[{key:"TryGetDefinition",value:function(t,e){return t in this._lists?this._lists[t]:e}},{key:"FindSingleItemListWithName",value:function(t){var e=f.Null,n=null,i=t.split(".");if(2==i.length)e=new f(i[0],i[1]),n=this.TryGetDefinition(e.originName,n);else for(var a in this._lists){var r=this._lists[a];if(e=new f(a,t),r.ContainsItem(e)){n=r;break}}if(null!=n){var o=n.ValueForItem(e);return new S(e,o)}return null}},{key:"lists",get:function(){var t=[];for(var e in this._lists)t.push(this._lists[e]);return t}}]),t}(),G=function(){function t(){n(this,t)}return a(t,null,[{key:"ListToJArray",value:function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.RuntimeObjectToJToken(t))}),n}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=t.length;e&&n--;for(var i=[],a=0;a<n;a++){var r=t[a],o=this.JTokenToRuntimeObject(r);i.push(o)}return i}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e={};for(var n in t)e[n]=this.JTokenToRuntimeObject(t[n]);return e}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={};for(var n in t){var i=t[n];i instanceof h&&(e[n]=this.RuntimeObjectToJToken(i))}return e}},{key:"JObjectToIntDictionary",value:function(t){var e={};for(var n in t)e[n]=parseInt(t[n]);return e}},{key:"IntDictionaryToJObject",value:function(t){var e={};for(var n in t)e[n]=t[n];return e}},{key:"JTokenToRuntimeObject",value:function(t){if(!isNaN(t)&&"\n"!==t)return m.Create(t);if("string"==typeof t){var n=t.toString(),i=n[0];if("^"==i)return new k(n.substring(1));if("\n"==i&&1==n.length)return new k("\n");if("<>"==n)return new O(E.Bidirectional);if("G<"==n)return new O(E.Left);if("G>"==n)return new O(E.Right);for(var a=0;a<q.length;++a){if(n==q[a])return new w(a)}if("L^"==n&&(n="^"),j.CallExistsWithName(n))return j.CallWithName(n);if("->->"==n)return w.PopTunnel();if("~ret"==n)return w.PopFunction();if("void"==n)return new F}if("object"===(void 0===t?"undefined":e(t))&&t instanceof Array==!1){var r,o=t;if(o["^->"])return r=o["^->"],new C(new u(r.toString()));if(o["^var"]){r=o["^var"];var s=new b(r.toString());return o.ci&&(r=o.ci,s.contextIndex=parseInt(r)),s}var l=!1,h=!1,c=I.Function,d=!1;if((r=o["->"])?l=!0:(r=o["f()"])?(l=!0,h=!0,c=I.Function):(r=o["->t->"])?(l=!0,h=!0,c=I.Tunnel):(r=o["x()"])&&(l=!0,d=!0,h=!1,c=I.Function),l){var p=new P;p.pushesToStack=h,p.stackPushType=c,p.isExternal=d;var y=r.toString();return(r=o.var)?p.variableDivertName=y:p.targetPathString=y,p.isConditional=!!o.c,d&&(r=o.exArgs)&&(p.externalArgs=parseInt(r)),p}if(r=o["*"]){var g=new A;return g.pathStringOnChoice=r.toString(),(r=o.flg)&&(g.flags=parseInt(r)),g}if(r=o["VAR?"])return new N(r.toString());if(r=o["CNT?"]){var _=new N;return _.pathStringForCount=r.toString(),_}var T=!1,x=!1;if((r=o["VAR="])?(T=!0,x=!0):(r=o["temp="])&&(T=!0,x=!1),T){var R=r.toString(),D=!o.re,B=new V(R,D);return B.isGlobal=x,B}if(void 0!==o["#"])return r=o["#"],new L(r.toString());if(r=o.list){var G=r,J=new v;if(r=o.origins){var M=r;J.SetInitialOriginNames(M)}for(var W in G){var K=G[W],U=new f(W),H=parseInt(K);J.Add(U,H)}return new S(J)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(t instanceof Array)return this.JArrayToContainer(t);if(null==t)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(t)}},{key:"RuntimeObjectToJToken",value:function(t){var e=t;if(e instanceof T)return this.ContainerToJArray(e);var n=t;if(n instanceof P){var i,a="->";return n.isExternal?a="x()":n.pushesToStack&&(n.stackPushType==I.Function?a="f()":n.stackPushType==I.Tunnel&&(a="->t->")),i=n.hasVariableTarget?n.variableDivertName:n.targetPathString,(f={})[a]=i,n.hasVariableTarget&&(f.var=!0),n.isConditional&&(f.c=!0),n.externalArgs>0&&(f.exArgs=n.externalArgs),f}var r=t;if(r instanceof A)return(f={})["*"]=r.pathStringOnChoice,f.flg=r.flags,f;if(t instanceof y)return t.value;if(t instanceof g)return t.value;var o=t;if(o instanceof k)return o.isNewline?"\n":"^"+o.value;var s=t;if(s instanceof S)return this.InkListToJObject(s);if(t instanceof C)return{"^->":t.value.componentsString};var u=t;if(u instanceof b)return{"^var":u.value,ci:u.contextIndex};var l=t;if(l instanceof O)return l.isBi?"<>":l.isLeft?"G<":"G>";if(t instanceof w)return q[parseInt(t.commandType)];if(t instanceof j){var h=t.name;return"^"==h&&(h="L^"),h}var c=t;if(c instanceof N){var f={},v=c.pathStringForCount;return null!=v?f["CNT?"]=v:f["VAR?"]=c.name,f}var d=t;if(d instanceof V)return(f={})[d.isGlobal?"VAR=":"temp="]=d.variableName,d.isNewDeclaration||(f.re=!0),f;if(t instanceof F)return"void";if(t instanceof L)return(f={})["#"]=t.text,f;var p=t;if(p instanceof R)return this.ChoiceToJObject(p);throw"Failed to convert runtime object to Json token: "+t}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&n.length>0||i>0||null!=t.name){var a;if(null!=n)for(var r in a=this.DictionaryRuntimeObjsToJObject(n)){var o=a[r];if(null!=o){var s=o[o.length-1];null!=s&&(delete s["#n"],0==Object.keys(s).length&&(o[o.length-1]=null))}}else a={};i>0&&(a["#f"]=i),null!=t.name&&(a["#n"]=t.name),e.push(a)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new T;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i={};for(var a in n)if("#f"==a)e.countFlags=parseInt(n[a]);else if("#n"==a)e.name=n[a].toString();else{var r=this.JTokenToRuntimeObject(n[a]);r instanceof T&&(r.name=a),i[a]=r}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new R;return e.text=t.text.toString(),e.index=parseInt(t.index),e.originalChoicePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.originalChoicePath,e.originalThreadIndex=t.originalThreadIndex,e}},{key:"InkListToJObject",value:function(t){var e=t.value,n={},i={};return e.forEach(function(t){var e=t.Key,n=t.Value;i[e.toString()]=n}),n.list=i,0==e.Count&&null!=e.originNames&&e.originNames.length>0&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={};return t.lists.forEach(function(t){var n={};t.items.forEach(function(t){var e=t.Key,i=t.Value;n[e.itemName]=i}),e[t.name]=n}),e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e){var a=i.toString(),r=e[i],o={};for(var s in r){var u=r[s];o[s]=parseInt(u)}var l=new D(a,o);n.push(l)}return new B(n)}}]),t}(),q=[];q[w.CommandType.EvalStart]="ev",q[w.CommandType.EvalOutput]="out",q[w.CommandType.EvalEnd]="/ev",q[w.CommandType.Duplicate]="du",q[w.CommandType.PopEvaluatedValue]="pop",q[w.CommandType.PopFunction]="~ret",q[w.CommandType.PopTunnel]="->->",q[w.CommandType.BeginString]="str",q[w.CommandType.EndString]="/str",q[w.CommandType.NoOp]="nop",q[w.CommandType.ChoiceCount]="choiceCnt",q[w.CommandType.TurnsSince]="turns",q[w.CommandType.ReadCount]="readc",q[w.CommandType.Random]="rnd",q[w.CommandType.SeedRandom]="srnd",q[w.CommandType.VisitIndex]="visit",q[w.CommandType.SequenceShuffleIndex]="seq",q[w.CommandType.StartThread]="thread",q[w.CommandType.Done]="done",q[w.CommandType.End]="end",q[w.CommandType.ListFromInt]="listInt",q[w.CommandType.ListRange]="range";for(var J=0;J<w.CommandType.TOTAL_VALUES;++J)if(null==q[J])throw"Control command not accounted for in serialisation";var M=function(){function t(e,i,a,r){n(this,t),this.currentContainer=i,this.currentContentIndex=a,this.inExpressionEvaluation=r||!1,this.temporaryVariables={},this.type=e}return a(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentContainer,this.currentContentIndex,this.inExpressionEvaluation);return r(e.temporaryVariables,this.temporaryVariables),e}},{key:"currentObject",get:function(){return this.currentContainer&&this.currentContentIndex<this.currentContainer.content.length?this.currentContainer.content[this.currentContentIndex]:null},set:function(t){var e=t;if(null==e)return this.currentContainer=null,void(this.currentContentIndex=0);this.currentContainer=e.parent,this.currentContainer instanceof T&&(this.currentContentIndex=this.currentContainer.content.indexOf(e)),this.currentContainer instanceof T!=!1&&-1!=this.currentContentIndex||(this.currentContainer=e,this.currentContentIndex=0)}}]),t}(),W=function(){function t(e,i){var a=this;if(n(this,t),this.callstack=[],this.threadIndex=0,this.previousContentObject=null,e&&i){var r=e;this.threadIndex=parseInt(r.threadIndex),r.callstack.forEach(function(t){var e=t,n=parseInt(e.type),r=null,o=0,s=null,l=e.cPath;void 0!==l&&(s=l.toString(),r=i.ContentAtPath(new u(s)),o=parseInt(e.idx));var h=!!e.exp,c=new M(n,r,o,h),f=e.temp;c.temporaryVariables=G.JObjectToDictionaryRuntimeObjs(f),a.callstack.push(c)});var o=r.previousContentObject;if(void 0!==o){var s=new u(o.toString());this.previousContentObject=i.ContentAtPath(s)}}}return a(t,[{key:"Copy",value:function(){var e=new t;return e.threadIndex=this.threadIndex,this.callstack.forEach(function(t){e.callstack.push(t.Copy())}),e.previousContentObject=this.previousContentObject,e}},{key:"jsonToken",get:function(){var t={},e=[];return this.callstack.forEach(function(t){var n={};t.currentContainer&&(n.cPath=t.currentContainer.path.componentsString,n.idx=t.currentContentIndex),n.exp=t.inExpressionEvaluation,n.type=parseInt(t.type),n.temp=G.DictionaryRuntimeObjsToJObject(t.temporaryVariables),e.push(n)}),t.callstack=e,t.threadIndex=this.threadIndex,null!=this.previousContentObject&&(t.previousContentObject=this.previousContentObject.path.toString()),t}}]),t}(),K=function(){function t(e){var i=this;n(this,t),this._threads=[],this._threadCounter=0,this._threads.push(new W),e instanceof t?(this._threads=[],e._threads.forEach(function(t){i._threads.push(t.Copy())})):this._threads[0].callstack.push(new M(I.Tunnel,e,0))}return a(t,[{key:"CanPop",value:function(t){return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(t){if(!this.CanPop(t))throw"Mismatched push/pop in Callstack";this.callStack.pop()}},{key:"Push",value:function(t){this.callStack.push(new M(t,this.currentElement.currentContainer,this.currentElement.currentContentIndex,!1))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw"Can't pop thread";this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"SetJsonToken",value:function(t,e){var n=this;this._threads.length=0;var i=t;i.threads.forEach(function(t){var i=new W(t,e);n._threads.push(i)}),this._threadCounter=parseInt(i.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[];return this._threads.forEach(function(t){e.push(t.jsonToken)}),t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"GetTemporaryVariableWithName",value:function(t,e){-1==(e=void 0===e?-1:e)&&(e=this.currentElementIndex+1);var n;return(n=this.callStack[e-1].temporaryVariables[t])?n:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){-1==(i=void 0===i?-1:i)&&(i=this.currentElementIndex+1);var a,r=this.callStack[i-1];if(!n&&!r.temporaryVariables[t])throw new _("Could not find temporary variable to set: "+t);(a=r.temporaryVariables[t])&&S.RetainListOriginsForAssignment(a,e),r.temporaryVariables[t]=e}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables[t]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){return this._threads.filter(function(e){if(e.threadIndex==t)return e})[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){return this.callStack[this.callStack.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1}}]),t}(),U=function(){function t(e,i){n(this,t),this._globalVariables={},this._callStack=e,this._listDefsOrigin=i,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return a(t,[{key:"ObserveVariableChange",value:function(t){var e=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(t,n){e.variableChangedEventCallbacks.forEach(function(e){e(t,n)})}),this.variableChangedEventCallbacks.push(t)}},{key:"CopyFrom",value:function(t){this._globalVariables=r({},t._globalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(t.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=t._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GetVariableWithName",value:function(t,e){void 0===e&&(e=-1);var n=this.GetRawVariableWithName(t,e),i=n;return i instanceof b&&(n=this.ValueAtVariablePointer(i)),n}},{key:"GetRawVariableWithName",value:function(t,e){var n=null;if(0==e||-1==e){if(n=this._globalVariables[t])return n;var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}if(null==(n=this._callStack.GetTemporaryVariableWithName(t,e)))throw"RUNTIME ERROR: Variable '"+t+"' could not be found in context '"+e+"'. This shouldn't be possible so is a bug in the ink engine. Please try to construct a minimal story that reproduces the problem and report to inkle, thank you!";return n}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName,i=-1,a=!1;if(a=t.isNewDeclaration?t.isGlobal:!!this._globalVariables[n],t.isNewDeclaration){var r=e;if(r instanceof b)e=this.ResolveVariablePointer(r)}else{var o=null;do{(o=this.GetRawVariableWithName(n,i))instanceof b&&(n=o.variableName,a=0==(i=o.contextIndex))}while(o instanceof b)}a?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=t,i=e;n instanceof S&&i instanceof S&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n;n=this._globalVariables[t],S.RetainListOriginsForAssignment(n,e),this._globalVariables[t]=e,null!=this.variableChangedEvent&&e!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(t):this.variableChangedEvent(t,e))}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=this.GetRawVariableWithName(t.variableName,e);return n instanceof b?n:new b(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables[t]?0:this._callStack.currentElementIndex}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables[t];return void 0!==n?n.valueObject:null}if(void 0===this._globalVariables[t])throw new _("Variable '"+t+"' doesn't exist, so can't be set.");var i=m.Create(e);if(null==i)throw new _(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){var e=this;t=!!t,this._batchObservingVariableChanges=t,t?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(t){var n=e._globalVariables[t];e.variableChangedEvent(t,n)}),this._changedVariables=null)}},{key:"jsonToken",get:function(){return G.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=G.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),H=function(){function t(e){n(this,t),this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}return a(t,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),$=function(){function t(e){n(this,t),this.story=e,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new K(e.rootContentContainer),this._variablesState=new U(this.callStack,e.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedTargetObject=null;var i=(new Date).getTime();this.storySeed=new H(i).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this.didSafeExit=!1,this._isExternalFunctionEvaluation=!1,this._originalCallstack=null,this._originalEvaluationStackHeight=0,this.GoToStart()}return a(t,[{key:"MatchRightGlueForLeftGlue",value:function(t){if(!t.isLeft)return null;for(var e=this._outputStream.length-1;e>=0;e--){var n=this._outputStream[e],i=n;if(i instanceof O&&i.isRight&&i.parent==t.parent)return i;if(n instanceof w)break}return null}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentContainer=this.story.mainContentContainer,this.callStack.currentElement.currentContentIndex=0}},{key:"ResetErrors",value:function(){this._currentErrors=null}},{key:"ResetOutput",value:function(){this._outputStream.length=0,this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=this;if(t instanceof S){var n=t.value,i=n.originNames;if(null!=i){var a=[];i.forEach(function(t){var n=null;n=e.story.listDefinitions.TryGetDefinition(t,n),a.indexOf(n)<0&&a.push(n)}),n.origins=a}}this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(t){if(t>this.evaluationStack.length)throw"trying to pop too many objects";return this.evaluationStack.splice(this.evaluationStack.length-t,t)}return this.evaluationStack.pop()}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(t){var e=this,n=t;if(n instanceof k){var i=this.TrySplittingHeadTailWhitespace(n);if(null!=i)return void i.forEach(function(t){e.PushToOutputStreamIndividual(t)})}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){for(var e=t.value,n=-1,i=-1,a=0;a<e.length;++a){if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==n&&(n=a),i=a}var r=-1,o=-1;for(a=0;a<e.length;++a){var s;if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==r&&(r=a),o=a}if(-1==n&&-1==r)return null;var u=[],l=0,h=e.length;if(-1!=n){if(n>0){var c=e.substring(0,n);u.push(c)}u.push(new k("\n")),l=i+1}if(-1!=r&&(h=o),h>l){var f=e.substring(l,h-l);u.push(new k(f))}if(-1!=r&&o>i&&(u.push(new k("\n")),r<e.length-1)){var v=e.Length-r-1,d=new k(e.substring(r+1,v));u.push(d)}return u}},{key:"PushToOutputStreamIndividual",value:function(t){var e=t,n=t,i=!0;if(e instanceof O){var a=this.currentRightGlue,r=(!e.isLeft||!a||(e.parent,a.parent),null);e.isLeft&&(r=this.MatchRightGlueForLeftGlue(e)),(e.isLeft||e.isBi)&&this.TrimNewlinesFromOutputStream(r),i=e.isBi||e.isRight}else n instanceof k&&(-1!=this.currentGlueIndex?n.isNewline?(this.TrimFromExistingGlue(),i=!1):n.isNonWhitespace&&this.RemoveExistingGlue():n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1)));i&&(this._outputStream.push(t),this.OutputStreamDirty())}},{key:"TrimNewlinesFromOutputStream",value:function(t){for(var e=-1,n=-1,i=!1,a=this._outputStream.length-1;a>=0;){var r=this._outputStream[a],o=r,s=r;if(r instanceof w||o instanceof k&&o.isNonWhitespace){if(i=!0,null==t)break}else{if(t&&s instanceof O&&s==t){n=a;break}o instanceof k&&o.isNewline&&!i&&(e=a)}a--}if(e>=0)for(a=e;a<this._outputStream.length;){this._outputStream[a]instanceof k?this._outputStream.splice(a,1):a++}if(t&&n>-1)for(a=n;a<this._outputStream.length;)this._outputStream[a]instanceof O&&this._outputStream[a].isRight?this.outputStream.splice(a,1):a++;this.OutputStreamDirty()}},{key:"TrimFromExistingGlue",value:function(){for(var t=this.currentGlueIndex;t<this._outputStream.length;){var e=this._outputStream[t];e instanceof k&&!e.isNonWhitespace?this._outputStream.splice(t,1):t++}this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof O)this._outputStream.splice(t,1);else if(e instanceof w)break}this.OutputStreamDirty()}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.callStack.Pop();this._currentChoices.length=0,this.currentContentObject=null,this.previousContentObject=null,this.didSafeExit=!0}},{key:"SetChosenPath",value:function(t){this._currentChoices.length=0,this.currentPath=t,this._currentTurnIndex++}},{key:"StartExternalFunctionEvaluation",value:function(t,e){this._originalCallstack=this.callStack,this._originalEvaluationStackHeight=this.evaluationStack.length,this.callStack=new K(t),this.callStack.currentElement.type=I.Function,this._variablesState.callStack=this.callStack,this._isExternalFunctionEvaluation=!0,this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string";this.PushEvaluationStack(m.Create(t[e]))}}},{key:"TryExitExternalFunctionEvaluation",value:function(){return!(!this._isExternalFunctionEvaluation||1!=this.callStack.elements.length||this.callStack.currentElement.type!=I.Function)&&(this.currentContentObject=null,this.didSafeExit=!0,!0)}},{key:"CompleteExternalFunctionEvaluation",value:function(){for(var t=null;this.evaluationStack.length>this._originalEvaluationStackHeight;){var e=this.PopEvaluationStack();null==t&&(t=e)}if(this.callStack=this._originalCallstack,this._originalCallstack=null,this._originalEvaluationStackHeight=0,this._variablesState.callStack=this.callStack,t){if(t instanceof F)return null;var n=t;return n.valueType==d.DivertTarget?n.valueObject.toString():n.valueObject}return null}},{key:"AddError",value:function(t){null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t)}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"VisitCountAtPathString",value:function(t){var e;return(e=this.visitCounts[t])?e:0}},{key:"Copy",value:function(){var e=new t(this.story);for(var n in e.outputStream.push.apply(e.outputStream,this._outputStream),this.OutputStreamDirty(),e._currentChoices.push.apply(e._currentChoices,this._currentChoices),this.hasError&&(e.currentErrors=[],e.currentErrors.push.apply(e.currentErrors,this.currentErrors)),e.callStack=new K(this.callStack),this._originalCallstack&&(e._originalCallstack=new K(this._originalCallstack)),e._variablesState=new U(e.callStack,this.story.listDefinitions),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),e._originalEvaluationStackHeight=this._originalEvaluationStackHeight,null!=this.divertedTargetObject&&(e.divertedTargetObject=this.divertedTargetObject),e.previousContentObject=this.previousContentObject,e._isExternalFunctionEvaluation=this._isExternalFunctionEvaluation,e._visitCounts={},this._visitCounts)e._visitCounts[n]=this._visitCounts[n];for(var n in e._turnIndices={},this._turnIndices)e._turnIndices[n]=this._turnIndices[n];return e._currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}},{key:"toJson",value:function(t){return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(t){this.callStack.currentElement.currentObject=t}},{key:"canContinue",get:function(){return null!=this.currentContentObject&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var t=this._outputStream.length-1;t>=0;t--){if(this._outputStream[t]instanceof w)break;var e=this._outputStream[t];if(e instanceof k){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof k)return!0;return!1}},{key:"currentGlueIndex",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof O)return t;if(e instanceof w)break}return-1}},{key:"currentRightGlue",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t],n=e;if(n instanceof O&&n.isRight)return n;if(e instanceof w)break}return null}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof w&&e.commandType==w.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t=new c;this._outputStream.forEach(function(e){var n=e;n instanceof k&&t.Append(n.value)}),this._currentText=t.toString(),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){var t=this;return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(function(e){var n=e;n instanceof L&&t._currentTags.push(n.text)}),this._outputStreamTagsDirty=!1),this._currentTags}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPath",get:function(){return null==this.currentContentObject?null:this.currentContentObject.path},set:function(t){this.currentContentObject=null!=t?this.story.ContentAtPath(t):null}},{key:"currentContainer",get:function(){return this.callStack.currentElement.currentContainer}},{key:"previousContentObject",get:function(){return this.callStack.currentThread.previousContentObject},set:function(t){this.callStack.currentThread.previousContentObject=t}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"jsonToken",get:function(){var e=this,n={},i=null;return this._currentChoices.forEach(function(t){t.originalChoicePath=t.choicePoint.path.componentsString,t.originalThreadIndex=t.threadAtGeneration.threadIndex,null==e.callStack.ThreadWithIndex(t.originalThreadIndex)&&(null==i&&(i={}),i[t.originalThreadIndex.toString()]=t.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(n.choiceThreads=this.choiceThreads),n.callstackThreads=this.callStack.GetJsonToken(),n.variablesState=this.variablesState.jsonToken,n.evalStack=G.ListToJArray(this.evaluationStack),n.outputStream=G.ListToJArray(this._outputStream),n.currentChoices=G.ListToJArray(this._currentChoices),null!=this.divertedTargetObject&&(n.currentDivertTarget=this.divertedTargetObject.path.componentsString),n.visitCounts=G.IntDictionaryToJObject(this.visitCounts),n.turnIndices=G.IntDictionaryToJObject(this.turnIndices),n.turnIdx=this.currentTurnIndex,n.storySeed=this.storySeed,n.inkSaveVersion=t.kInkSaveStateVersion,n.inkFormatVersion=this.story.inkVersionCurrent,n},set:function(e){var n=this,i=e,a=i.inkSaveVersion;if(null==a)throw new _("ink save format incorrect, can't load.");if(parseInt(a)<t.kMinCompatibleLoadVersion)throw new _("Ink save format isn't compatible with the current version (saw '"+a+"', but minimum is "+t.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(i.callstackThreads,this.story),this.variablesState.jsonToken=i.variablesState,this._evaluationStack=G.JArrayToRuntimeObjList(i.evalStack),this._outputStream=G.JArrayToRuntimeObjList(i.outputStream),this.OutputStreamDirty(),this._currentChoices=G.JArrayToRuntimeObjList(i.currentChoices);var r=i.currentDivertTarget;if(null!=r){var o=new u(r.toString());this.divertedTargetObject=this.story.ContentAtPath(o)}this._visitCounts=G.JObjectToIntDictionary(i.visitCounts),this._turnIndices=G.JObjectToIntDictionary(i.turnIndices),this._currentTurnIndex=parseInt(i.turnIdx),this.storySeed=parseInt(i.storySeed);var s=i.choiceThreads;this._currentChoices.forEach(function(t){t.choicePoint=n.story.ContentAtPath(new u(t.originalChoicePath));var e=n.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e;else{var i=s[t.originalThreadIndex.toString()];t.threadAtGeneration=new K.Thread(i,n.story)}})}}]),t}();$.kInkSaveStateVersion=7,$.kMinCompatibleLoadVersion=6,Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});var z=function(t){function i(t,e){n(this,i);var a=s(this,(i.__proto__||Object.getPrototypeOf(i)).call(this));if(e=e||null,a.inkVersionCurrent=17,a.inkVersionMinimumCompatible=16,a._variableObservers=null,a._externals={},a._prevContainerSet=null,a._listDefinitions=null,t instanceof T)a._mainContentContainer=t,null!=e&&(a._listDefinitions=new B(e));else{var r="string"==typeof t?JSON.parse(t):t,o=r.inkVersion;if(null==o)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var u=parseInt(o);if(u>a.inkVersionCurrent)throw"Version of ink used to build story was newer than the current verison of the engine";if(u<a.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this verison of the engine";u!=a.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var l,h=r.root;if(null==h)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";(l=r.listDefs)&&(a._listDefinitions=G.JTokenToListDefinitions(l)),a._mainContentContainer=G.JTokenToRuntimeObject(h),a._hasValidatedExternals=null,a.allowExternalFunctionFallbacks=!1,a.ResetState()}return a}return o(i,h),a(i,[{key:"ToJsonString",value:function(){var t=G.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=G.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this._state=new $(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var t=this.state.currentPath;this.ChoosePathString("global decl"),this.ContinueInternal(),this.state.currentPath=t}}},{key:"Continue",value:function(){return this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal()}},{key:"ContinueInternal",value:function(){if(!this.canContinue)throw new _("Can't continue - should check canContinue before calling Continue");this._state.ResetOutput(),this._state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!0;try{var t=null;do{if(this.Step(),this.canContinue||this.TryFollowDefaultInvisibleChoice(),!this.state.inStringEvaluation){if(null!=t){var e=this.currentText,n=t.currentText.length,i=t.currentTags.length;if(e!==t.currentText||i!=this.currentTags.length){if(e.length>=n&&"\n"==e[n-1]){this.RestoreStateSnapshot(t);break}t=null}}this.state.outputStreamEndsInNewline&&(this.canContinue?null==t&&(t=this.StateSnapshot()):t=null)}}while(this.canContinue);null!=t&&this.RestoreStateSnapshot(t),this.canContinue||(this.state.callStack.canPopThread&&this.Error("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(I.Tunnel)?this.Error("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(I.Function)?this.Error("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.Error("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.Error("ran out of content. Do you need a '-> DONE' or '-> END'?")))}catch(t){throw t}finally{this.state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!1}return this.currentText}},{key:"ContinueMaximally",value:function(){for(var t=new c;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentContentObject;if(null!=e){for(var n=e;n instanceof T&&(this.VisitContainer(n,!0),0!=n.content.length);)e=n.content[0],this.state.callStack.currentElement.currentContentIndex=0,this.state.callStack.currentElement.currentContainer=n,n=e;n=this.state.callStack.currentElement.currentContainer;var i=this.PerformLogicAndFlowControl(e);if(null!=this.state.currentContentObject){i&&(t=!1);var a=e;if(a instanceof A){var r=this.ProcessChoice(a);r&&this.state.generatedChoices.push(r),e=null,t=!1}if(e instanceof T&&(t=!1),t){var o=e;if(o instanceof b&&-1==o.contextIndex){var s=this.state.callStack.ContextForVariableNamed(o.variableName);e=new b(o.variableName,s)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(e):this.state.PushToOutputStream(e)}this.NextContent();e instanceof w&&e.commandType==w.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousContentObject,e=this.state.currentContentObject;if(e){if(this._prevContainerSet=[],t)for(var n=t instanceof T?t:t.parent;n instanceof T;)this._prevContainerSet.push(n),n=n.parent;for(var i=e,a=i.parent;a instanceof T&&this._prevContainerSet.indexOf(a)<0;){var r=a.content.length>0&&i==a.content[0];this.VisitContainer(a,r),i=a,a=a.parent}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",a="";t.hasChoiceOnlyContent&&(a=this.state.PopEvaluationStack().value);t.hasStartContent&&(i=this.state.PopEvaluationStack().value);t.onceOnly&&(this.VisitCountForContainer(t.choiceTarget)>0&&(e=!1));var r=new R(t);return r.threadAtGeneration=this.state.callStack.currentThread.Copy(),e?(r.text=i+a,r):null}},{key:"IsTruthy",value:function(t){if(t instanceof m){var e=t;if(e instanceof C){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof P){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,a=this.state.variablesState.GetVariableWithName(i);if(!(a instanceof C)){var r="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof y&&0==a.value?r+="was empty/null (the value 0).":r+="contained '"+a+"'.",this.Error(r)}var o=a;this.state.divertedTargetObject=this.ContentAtPath(o.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedTargetObject=e.targetContent}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType),null!=this.state.divertedTargetObject||e.isExternal||(e&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof w){var s=t;switch(s.commandType){case w.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case w.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case w.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var u=this.state.PopEvaluationStack();if(null!=u&&!(u instanceof F)){var l=new k(u.toString());this.state.PushToOutputStream(l)}}break;case w.CommandType.NoOp:break;case w.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case w.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case w.CommandType.PopFunction:case w.CommandType.PopTunnel:var h=s.commandType==w.CommandType.PopFunction?I.Function:I.Tunnel,f=null;if(h==I.Tunnel){var v=this.state.PopEvaluationStack();if((f=v)instanceof C==!1){if(v instanceof F==!1)throw"Expected void if ->-> doesn't override target";f=null}}if(this.state.TryExitExternalFunctionEvaluation())break;if(this.state.callStack.currentElement.type==h&&this.state.callStack.canPop)this.state.callStack.Pop(),f&&(this.state.divertedTargetObject=this.ContentAtPath(f.targetPath));else{var d={};d[I.Function]="function return statement (~ return)",d[I.Tunnel]="tunnel onwards statement (->->)";var p=d[this.state.callStack.currentElement.type];this.state.callStack.canPop||(p="end of flow (-> END or choice)");var m="Found "+d[h]+", when expected "+p;this.Error(m)}break;case w.CommandType.BeginString:this.state.PushToOutputStream(s),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case w.CommandType.EndString:for(var g=[],b=0,T=this.state.outputStream.length-1;T>=0;--T){var O=this.state.outputStream[T];b++;if(O instanceof w&&O.commandType==w.CommandType.BeginString)break;O instanceof k&&g.push(O)}this.state.outputStream.splice(this.state.outputStream.length-b,b),g=g.reverse();var E=new c;g.forEach(function(t){E.Append(t.toString())}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new k(E.toString()));break;case w.CommandType.ChoiceCount:var x=this.state.generatedChoices.length;this.state.PushEvaluationStack(new y(x));break;case w.CommandType.TurnsSince:case w.CommandType.ReadCount:if(!((o=this.state.PopEvaluationStack())instanceof C)){var A="";o instanceof y&&(A=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+o+A);break}var L,R=o,D=this.ContentAtPath(R.targetPath);L=s.commandType==w.CommandType.TurnsSince?this.TurnsSinceForContainer(D):this.VisitCountForContainer(D),this.state.PushEvaluationStack(new y(L));break;case w.CommandType.Random:var B=this.state.PopEvaluationStack(),G=this.state.PopEvaluationStack();null!=G&&G instanceof y!=!1||this.Error("Invalid value for minimum parameter of RANDOM(min, max)"),null!=B&&G instanceof y!=!1||this.Error("Invalid value for maximum parameter of RANDOM(min, max)");var q=B.value-G.value+1;q<=0&&this.Error("RANDOM was called with minimum as "+G.value+" and maximum as "+B.value+". The maximum must be larger");var J=this.state.storySeed+this.state.previousRandom,M=new H(J).next(),W=M%q+G.value;this.state.PushEvaluationStack(new y(W)),this.state.previousRandom=M;break;case w.CommandType.SeedRandom:var K=this.state.PopEvaluationStack();null!=K&&K instanceof y!=!1||this.Error("Invalid value passed to SEED_RANDOM"),this.state.storySeed=K.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new F);break;case w.CommandType.VisitIndex:var U=this.VisitCountForContainer(this.state.currentContainer)-1;this.state.PushEvaluationStack(new y(U));break;case w.CommandType.SequenceShuffleIndex:var $=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new y($));break;case w.CommandType.StartThread:break;case w.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentContentObject=null);break;case w.CommandType.End:this.state.ForceEnd();break;case w.CommandType.ListFromInt:var z,X=parseInt(this.state.PopEvaluationStack()),Q=this.state.PopEvaluationStack().toString(),Y=null;if(!(z=this.listDefinitions.TryGetDefinition(Q,z)))throw new _("Failed to find LIST called "+Q.value);var Z=z.TryGetItemWithValue(X.value);Z.exists&&(Y=new S(Z.item,X.value)),null==Y&&(Y=new S),this.state.PushEvaluationStack(Y);break;case w.CommandType.ListRange:var tt=this.state.PopEvaluationStack(),et=this.state.PopEvaluationStack(),nt=this.state.PopEvaluationStack();if(nt instanceof S==!1||null==nt||null==et||null==tt)throw new _("Expected list, minimum and maximum for LIST_RANGE");var it=function(t){if(t instanceof S)return parseInt(t.value.maxItem.Value);return t instanceof y?t.value:-1},at=it(et),rt=it(tt);if(-1==at)throw new _("Invalid min range bound passed to LIST_VALUE(): "+et);if(-1==rt)throw new _("Invalid max range bound passed to LIST_VALUE(): "+tt);var ot=new S,st=nt.value.origins;null!=st&&st.forEach(function(t){t.ListRange(at,rt).value.forEach(function(t){ot.value.Add(t.Key,t.Value)})}),this.state.PushEvaluationStack(ot);break;default:this.Error("unhandled ControlCommand: "+s)}return!0}if(t instanceof V){var ut=t,lt=this.state.PopEvaluationStack();return this.state.variablesState.Assign(ut,lt),!0}if(t instanceof N){var ht=t,ct=null;if(null!=ht.pathForCount){D=ht.containerForCount,U=this.VisitCountForContainer(D);ct=new y(U)}else null==(ct=this.state.variablesState.GetVariableWithName(ht.name))&&(this.Error("Uninitialised variable: "+ht.name),ct=new y(0));return this.state.PushEvaluationStack(ct),!0}if(t instanceof j){var ft=t,vt=this.state.PopEvaluationStack(ft.numberOfParameters);ot=ft.Call(vt);return this.state.PushEvaluationStack(ot),!0}return!1}},{key:"ChoosePathString",value:function(t,e){e=e||[],this.state.PassArgumentsToEvaluationStack(e),this.ChoosePath(new u(t))}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;(t<0||t>e.length)&&console.warn("choice out of range");var n=e[t];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.choicePoint.choiceTarget.path)}},{key:"HasFunction",value:function(t){try{return this.ContentAtPath(new u(t))instanceof T}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,e,n){if(n=!!n,null==t)throw"Function is null";if(""==t||""==t.trim())throw"Function is empty or white space.";var i=null;try{i=this.ContentAtPath(new u(t))}catch(e){throw e.message.indexOf("not found")>=0?"Function doesn't exist: '"+t+"'":e}this.state.StartExternalFunctionEvaluation(i,e);for(var a=new c;this.canContinue;)a.Append(this.Continue());var r=a.toString(),o=this.state.CompleteExternalFunctionEvaluation();return n?{returned:o,output:r}:o}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(I.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.callStack.Pop(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,n){var i=this._externals[t],a=null;if(!(void 0!==i)){if(this.allowExternalFunctionFallbacks)return(a=this.ContentAtPath(new u(t)))instanceof T||console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(I.Function),void(this.state.divertedTargetObject=a);console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var r=[],o=0;o<n;++o){var s=this.state.PopEvaluationStack().valueObject;r.push(s)}r.reverse();var l=i(r),h=null;null!=l?null==(h=m.Create(l))&&console.warn("Could not create ink value from returned object of type "+(void 0===l?"undefined":e(l))):h=new F,this.state.PushEvaluationStack(h)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunctionGeneral",value:function(t,e){this._externals[t]&&console.warn("Function '"+t+"' has already been bound."),this._externals[t]=e}},{key:"BindExternalFunction",value:function(t,e){var n=this;e||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){t.length<e.length&&console.warn("External function expected "+e.length+" arguments");for(var i=[],a=0,r=t.length;a<r;a++)i[a]=n.TryCoerce(t[a]);return e.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(t){void 0===this._externals[t]&&console.warn("Function '"+t+"' has not been bound."),delete this._externals[t]}},{key:"ValidateExternalBindings",value:function(t,e){var n=this;if(t)if(t instanceof T){var i=t;for(var a in i.content.forEach(function(t){n.ValidateExternalBindings(t,e)}),i.namedContent)this.ValidateExternalBindings(i.namedContent[a],e)}else{var r=t;if(r instanceof P&&r.isExternal){var o=r.targetPathString;if(!this._externals[o])if(this.allowExternalFunctionFallbacks)!!this.mainContentContainer.namedContent[o]||e.push(o);else e.push(o)}}else{e=[];if(this.ValidateExternalBindings(this._mainContentContainer,e),this._hasValidatedExternals=!0,0==e.length)this._hasValidatedExternals=!0;else{var s="Error: Missing function binding for external";s+=e.length>1?"s":"",s+=": '",s+=e.join("', '"),s+="' ",s+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(s)}}}},{key:"ObserveVariable",value:function(t,e){null==this._variableObservers&&(this._variableObservers={}),this._variableObservers[t]?this._variableObservers[t].push(e):this._variableObservers[t]=[e]}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(null!=this._variableObservers)if(void 0!==e)this._variableObservers[e]&&this._variableObservers[e].splice(this._variableObservers[e].indexOf(t),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(t),1)}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!=this._variableObservers){var n=this._variableObservers[t];if(void 0!==n){if(!(e instanceof m))throw"Tried to get the value of a variable that isn't a standard type";var i=e;n.forEach(function(e){e(t,i.valueObject)})}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){for(var e=new u(t),n=this.ContentAtPath(e);;){var i=n.content[0];if(!(i instanceof T))break;n=i}var a=null;return n.content.every(function(t){var e=t;return e instanceof L&&(null==a&&(a=[]),a.push(e.text),!0)}),a}},{key:"BuildStringOfHierarchy",value:function(){var t=new c;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentContentObject),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new c;return t.BuildStringOfHierarchy(e,0,this.state.currentContentObject),e.toString()}},{key:"NextContent",value:function(){if((this.state.previousContentObject=this.state.currentContentObject,null==this.state.divertedTargetObject||(this.state.currentContentObject=this.state.divertedTargetObject,this.state.divertedTargetObject=null,this.VisitChangedContainersDueToDivert(),null==this.state.currentContentObject))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(I.Function)?(this.state.callStack.Pop(I.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new F),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitExternalFunctionEvaluation(),t&&null!=this.state.currentContentObject&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement;for(e.currentContentIndex++;e.currentContentIndex>=e.currentContainer.content.length;){t=!1;var n=e.currentContainer.parent;if(n instanceof T==!1)break;var i=n.content.indexOf(e.currentContainer);if(-1==i)break;e.currentContainer=n,e.currentContentIndex=i+1,t=!0}return t||(e.currentContainer=null),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.choicePoint.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return this.ChoosePath(n.choicePoint.choiceTarget.path),!0}},{key:"VisitCountForContainer",value:function(t){if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return e=this.state.visitCounts[n]||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts[n]&&(e=this.state.visitCounts[n]),e++,this.state.visitCounts[n]=e}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices[e]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices[e];return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=this.state.PopEvaluationStack();if(!(t instanceof y))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var e=this.state.currentContainer,n=t.value,i=this.state.PopEvaluationStack().value,a=i/n,r=i%n,o=e.path.toString(),s=0,u=0,l=o.length;u<l;u++)s+=o.charCodeAt[u]||0;var h=s+a+this.state.storySeed,c=new H(parseInt(h)),f=[];for(u=0;u<n;++u)f.push(u);for(u=0;u<=r;++u){var v=c.next()%f.length,d=f[v];if(f.splice(v,1),u==r)return d}throw"Should never reach here"}},{key:"Error",value:function(t,e){throw new _(t)}},{key:"AddError",value:function(t,e){t="RUNTIME ERROR: "+t,this.state.AddError(t),this.state.ForceEnd()}},{key:"currentChoices",get:function(){var t=[];return this._state.currentChoices.forEach(function(e){e.choicePoint.isInvisibleDefault||(e.index=t.length,t.push(e))}),t}},{key:"currentText",get:function(){return this.state.currentText}},{key:"currentTags",get:function(){return this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"hasError",get:function(){return this.state.hasError}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}}]),i}();t.Story=z,Object.defineProperty(t,"__esModule",{value:!0})}),function(t){var e=new inkjs.Story(t),n=document.querySelectorAll(".app")[0],i=document.querySelectorAll(".phone-container")[0];function a(){for(;e.canContinue;){var t=e.Continue(),r=document.createElement("div");r.className="recipient",r.innerHTML=t,n.appendChild(r)}var o;e.currentChoices.forEach(function(t){var r=document.createElement("div");r.classList.add("choices"),r.setAttribute("id",t.index),r.innerHTML=t.text,i.appendChild(r),r.addEventListener("click",function(r){r.preventDefault();var o=document.createElement("div");o.className="sender",o.innerHTML=t.text,n.appendChild(o);for(var s=i.querySelectorAll(".choices"),u=0;u<s.length;u++){var l=s[u];l.parentNode.removeChild(l)}e.ChooseChoiceIndex(t.index);setTimeout(a,1e3)})}),(o=$(".app")).animate({scrollTop:o.prop("scrollHeight")-o.height()},1e3)}$("body").on("click",".message",function(t){$(".introduction").css("display","none"),$(".message").css("display","none"),$(".avatar").css("display","block"),$(".contact-name").text("Louise"),$(".app").show(200),a()})}(storyContent);var storyContent={inkVersion:17,root:["^Salut Emma, c'est Louise c'est gnial d'avoir pu echanger nos numros on pourra discuter plus facilement.","\n",["ev","str","^Salut Louise !","/str","/ev",{"*":"2.c",flg:20},{c:["\n",{"->":"normal_flow"},"\n",{"#f":7}]}],["ev","str","^Bonjour, dsol je pense que c'est finalement une mauvaise ide...","/str","/ev",{"*":"3.c",flg:20},{c:["\n",{"->":"badidea"},"\n",{"#f":7}]}],"done",{normal_flow:["^Alors dis moi tout, comme ca tu veux un chien?","\n",["ev","str","^Oui, comme je te l'ai dis je vis avec mon frre malade, c'est la seule personne que j'ai au monde et j'aimerais pouvoir au moins lui offrir un chien! ^^ ","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"normal_flow2"},"\n",{"#f":7}]}],["ev","str","^Oui...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"normal_flow2"},"\n",{"#f":7}]}],{"#f":3}],normal_flow2:["^Ok du coup tu te souviens des conditions?","\n",["ev","str","^Oui","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"explication2"},"\n",{"#f":7}]}],["ev","str","^Non...je t'avouerais que je n'ai pas trop compris, pourrais tu me rexpliquer?","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"explication"},"\n",{"#f":7}]}],{"#f":3}],explication:["^Comme je te l'ai dis auparavant je suis une peintre et pour m'excercer j'ai besoin d'un modle de corps humain nu d'une jeune fille de ton ge, tant timide je prfre demander  des filles sur internet en change de services ^^.","\n",["ev","str","^Nu...comment ca nu?? ","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_3"},"\n",{"#f":7}]}],["ev","str","^Ok comment ca se passe du coup?","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"explication2"},"\n",{"#f":7}]}],{"#f":3}],explication2:["^Bien! Pour commencer envoi moi une photo de toi nue avec ton visage bien visible?","\n",["ev","str","^Mon visage aussi?? Je pensais qu'il ne te fallait que mon corps... ","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"hesitation2"},"\n",{"#f":7}]}],{"#f":3}],hesitation2:["^Il me faut ton visage aussi sans ca je ne peux pas bien bien dessiner le reste du corps, ce n'est pas cher pay pour ce que je t'offre et puis j'ai eu beaucoup de propositions mais je t'ai choisi car l'histoire de ton frre m'a touch...Allons tu ne veux pas lui offrir un chien?","\n",["ev","str","^*Envoyer la photo*","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"addresse"},"\n",{"#f":7}]}],{"#f":3}],addresse:["^Parfait! Maitenant il me faut aussi ton addresse postale!","\n",["ev","str","^Mon addresse?...Pourquoi faire?","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"addresse2"},"\n",{"#f":7}]}],["ev","str","^Pourquoi mon addresse?","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"addresse2"},"\n",{"#f":7}]}],{"#f":3}],addresse2:["^Il me la faut pour que je puisse t'envoyer ton chien.","\n",["ev","str","^Oui c'est vrai tu as raison... *envoyer l'adresse*","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"nightmare_begin"},"\n",{"#f":7}]}],{"#f":3}],nightmare_begin:["^Maintenant j'aurais besoins que tu m'envois d'autres photos!","\n",["ev","str","^D'autres photos?... Comment ca?","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"incomprehension"},"\n",{"#f":7}]}],["ev","str","^D'autres photos? Ce n'tait pas dans notre accord!","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"refuse"},"\n",{"#f":7}]}],{"#f":3}],incomprehension:["^Oui il me faudrait des photos dans d'autres positions, d'autres lieux...","\n",["ev","str","^Non! Ce n'est pas du tout ce qu'on avait prvu","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"threat"},"\n",{"#f":7}]}],{"#f":3}],refuse:["^Un chien ca coute cher, tu penses bien qu'il va me falloir plus qu'une photo pour qu'on soit  galit.","\n",["ev","str","^Non! Je ne veux pas faire d'autres photo, je veux juste mon chien!","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"threat"},"\n",{"#f":7}]}],{"#f":3}],threat:["^Tu ne veux pas faire d'autres photos? Trs bien mais n'oublies pas que j'ai ton addresse...","\n",["ev","str","^Tu commences...  me faire peur, arrtes s'il te plait ce n'est pas drle !","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"medium_ending"},"\n",{"#f":7}]}],{"#f":3}],badidea:["^Une mauvaise ide? Comment ca? Je ne comprends pas...","\n",["ev","str","^Oui.. Je veux dire on se connait  peine, c'est un peu intimidant pour moi...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_2"},"\n",{"#f":7}]}],["ev","str","^Non...dsol oublie mon message, je me fais des ides pour rien.","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"normal_flow"},"\n",{"#f":7}]}],{"#f":3}],badidea_2:["^Tu as raison d'avoir peur, mais je t'assure je ne suis pas une mauvaise personne et puis ce n'est juste qu'un change de service non?","\n",["ev","str","^...Oui mais faire ca me gne un peu...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_3"},"\n",{"#f":7}]}],["ev","str","^Tu as raison... je suis trop mfiante et puis je dois bien prendre ce risque pour lui...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"normal_flow"},"\n",{"#f":7}]}],{"#f":3}],badidea_3:["^Allons voyons on est entre femmes et puis je fais ca  titre professionnel personne ne le verra.","\n",["ev","str","^Merci pour la proposition mais je ne pense pas accepter, au revoir","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_4"},"\n",{"#f":7}]}],["ev","str","^Je ne sais pas, aprs tout je ne t'ai jamais vu...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"hesitation"},"\n",{"#f":7}]}],{"#f":3}],hesitation:["^Je peux t'envoyer une photo de moi pour te prouver que je suis honnte si tu veux?","\n",["ev","str","^Non dsol, aurevoir!","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_4"},"\n",{"#f":7}]}],["ev","str","^Avec la photo... je pense que j'aurais moins de doutes...","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"photo_louise"},"\n",{"#f":7}]}],{"#f":3}],photo_louise:["^Tiens voila ma photo, ne la partages pas svp.","\n",["ev","str","^Je comprends ne t'en fais, tu es plutot jolie!","/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"explication2"},"\n",{"#f":7}]}],{"#f":3}],badidea_4:["^Pourquoi Emma? Tu me vexes la? Tu ne me fais pas confiance, tu ne veux pas de ton chien et faire plaisir  ton petit frre???","\n",["ev","str",'^"..." ',"/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_5"},"\n",{"#f":7}]}],{"#f":3}],badidea_5:["^Tu m'avais promis que tu le ferais, tu n'es qu'une menteuse Emma, une sale petite menteuse!!!","\n",["ev","str",'^"..."',"/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"badidea_6"},"\n",{"#f":7}]}],{"#f":3}],badidea_6:["^Rponds moi! Je vais vraiment me fcher! Rponds moi!","\n",["ev","str",'^"..."',"/str","/ev",{"*":".^.c",flg:20},{c:["\n",{"->":"good_ending"},"\n",{"#f":7}]}],{"#f":3}],medium_ending:[["^\"Malgrs le blackmailling de 'Louise' vous avez quand mme dcid de prvenir les autorits, suite  une enqute la police dcouvrit que Louise tait Matthew Falder, gophysicien diplm de luniversit de Cambridge et producteur de documents  hurtcore  une communaut sadique et malvaillante du dark web. Dans les informations rcupres chez lui on retrouva des traces de vos conversations et vos photos, enregistr dans un dossier nomm 'Victime 5', malheursement avant de se faire arrter il a eu le temps de le partager publquement. Vous avait souffert de nombreuses annes de cet vnement de votre vie et vous avez du dmnager de nombreuses fois mais aujourd'hui vous vivez heureuse avec votre frre et...un chien nomm Pluto\"","\n",["end",{"#f":7,"#n":"g-0"}],null],{"#f":3}],good_ending:[['^"Vous avez finalement dcid de bloquer le numros de "Louise" et de prvenir un adulte, une plainte fut dpose et on dcouvrit plus tard que Louise tait Matthew Falder, gophysicien diplm de luniversit de Cambridge et producteur de documents  hurtcore  une communaut sadique et malvaillante du dark web. Dans les informations rcupres chez lui on retrouva des traces de vos conversations, enregistr dans un dossier nomm \'Victime 5\'"',"\n",["end",{"#f":7,"#n":"g-0"}],null],{"#f":3}],"#f":3}],listDefs:{}};